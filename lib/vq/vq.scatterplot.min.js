vq.ScatterPlot=function(){vq.Vis.call(this),this.height(300),this.width(700),this.vertical_padding(20),this.horizontal_padding(30),this.selectedProbesetId("")},vq.ScatterPlot.prototype=vq.extend(vq.Vis),vq.ScatterPlot.prototype.property("selectedProbesetId"),vq.ScatterPlot.prototype._setOptionDefaults=function(a){a.selectedProbesetId&&(this._selectedProbesetId=a.selectedProbesetId),a.height!=null&&this.height(a.height),a.width!=null&&this.width(a.width),a.container!=null&&this.container(a.container),a.vertical_padding!=null&&this.vertical_padding(a.vertical_padding),a.horizontal_padding!=null&&this.horizontal_padding(a.horizontal_padding)},vq.ScatterPlot.prototype.onProbesetSelect=function(a){this.selectedProbesetId=a},vq.ScatterPlot.prototype.setRegression=function(a){this.data._regression=a||"none",this._render()},vq.ScatterPlot.prototype.draw=function(a){var b=this;this.data=new vq.models.ScatterPlotData(a);if(!!this.data.isDataReady()){this._setOptionDefaults(this.data),this._visHeight=this.height()-2*this.vertical_padding(),this._visWidth=this.width()-2*this.horizontal_padding();var c=this.data,d=c.COLUMNID.x,e=c.COLUMNID.y;this.x=d,this.y=e,this.horizontal_padding=c.horizontal_padding,this.vertical_padding=c.vertical_padding;var f=c.COLUMNID.value;this.data_array=c.data;var g=this.data_array.reduce(function(a,b){return b[d]!=null&&b[d]<a?b[d]:a},999999),h=this.data_array.reduce(function(a,b){return b[d]!=null&&b[d]>a?b[d]:a},-999999),i=this.data_array.reduce(function(a,b){return b[e]!=null&&b[e]<a?b[e]:a},999999),j=this.data_array.reduce(function(a,b){return b[e]!=null&&b[e]>a?b[e]:a},-999999),k=g-Math.abs(h-g)*.03,l=h+Math.abs(h-g)*.03,m=i-Math.abs(j-i)*.03,n=j+Math.abs(j-i)*.03;this.xScale=d3.scale.linear().domain([k,l]).range([0,this.width()]),this.yScale=d3.scale.linear().domain([m,n]).range([this.height(),0]);var o=c._regression;if(o=="linear")var p=this.data_array.filter(function(a,b,c){return a[e]&&a[d]}),q=d3.sum(p,function(a){return a[d]}),r=d3.sum(p,function(a){return a[e]}),s=d3.sum(p,function(a){return a[d]*a[d]}),t=d3.sum(p,function(a){return a[d]*a[e]}),u=(p.length*t-q*r)/(p.length*s-q*q),v=(r-u*q)/p.length;var w=k*.95,x=l*1.05,y=u*x+v,z=u*w+v,A=d3.scale.linear().domain([w,x]).range([z,y]);this.regressData={type:o,minX:w,maxX:x,scale:A},this.vis=d3.select(this.container()).append("svg").attr("width",this.width()+2*this.horizontal_padding).attr("height",this.height()+2*this.vertical_padding),this.data_g=this.vis.append("g").attr("transform","translate("+this.horizontal_padding+","+this.vertical_padding+")").attr("width",this.width()).attr("height",this.height()),this.data_rect=this.data_g.append("rect").attr("class","data-rect").attr("width",this.width()).attr("height",this.height()).attr("pointer-events","all"),this.data_g.append("g").append("text").attr("class","axis").text(c.COLUMNLABEL.y).style("text-anchor","middle").attr("transform","translate("+ -this.horizontal_padding/2+","+this.height()/2+") rotate(-90)"),this.data_g.append("text").attr("class","axis").text(c.COLUMNLABEL.x).attr("x",this.width()/2).attr("y",this.height()+this.vertical_padding/2).style("text-anchor","middle");var B=this.data_g.append("svg").attr("left",0).attr("top",0).attr("width",this.width()).attr("height",this.height()).attr("viewBox","0 0 "+this.width()+" "+this.height()).attr("class","symbols");B.append("line").attr("class","regression"),this.brush=d3.svg.brush(),this._render()}},vq.ScatterPlot.prototype._render=function(){var a=this,b=function(b){return"translate(0,"+a.yScale(b)+")"},c=this.data_g.selectAll("g.y-tick").data(this.yScale.ticks(10),String).attr("transform",b),d=c.enter().insert("g","a").attr("class","y-tick").attr("transform",b);d.append("line").attr("x1",0).attr("x2",this.width()).attr("stroke","#ccc"),d.append("text").attr("class","axis").attr("x",-5).attr("text-anchor","end").text(d3.format("3.2f")),c.exit().remove();var e=function(b){return"translate("+a.xScale(b)+",0)"},f=this.data_g.selectAll("g.x-tick").data(this.xScale.ticks(10)).attr("transform",e),g=f.enter().insert("g","a").attr("class","x-tick").attr("transform",e);g.append("line").attr("y1",0).attr("y2",this.height()).attr("stroke","#ccc"),g.append("text").attr("class","axis").attr("y",this.height()).attr("dy",".71em").attr("text-anchor","middle").text(d3.format("3.2f")),f.exit().remove(),a.drawData()},vq.ScatterPlot.prototype.drawData=function(){var a=this,b=this.data.data,c=this.data_g.select("svg.symbols").selectAll("circle").data(b);c.enter().append("circle").attr("class","fg").attr("cx",function(b){return a.xScale(b[a.x])}).attr("cy",function(b){return a.yScale(b[a.y])}).attr("r",2),c.attr("cx",function(b){return a.xScale(b[a.x])}).attr("cy",function(b){return a.yScale(b[a.y])}),c.exit().remove();if(this.regressData.type=="linear"){var d=a.regressData;this.data_g.select("svg.symbols").select("line.regression").attr("x1",a.xScale(d.minX)).attr("y1",a.yScale(d.scale(d.minX))).attr("x2",a.xScale(d.maxX)).attr("y2",a.yScale(d.scale(d.maxX)))}},vq.ScatterPlot.prototype.resetData=function(a){this.data.data=a,this.drawData()},vq.ScatterPlot.prototype.removeListeners=function(){this.data_rect.on("mousedown.zoom",null).on("mousewheel.zoom",null).on("mousemove.zoom",null).on("DOMMouseScroll.zoom",null).on("dblclick.zoom",null).on("touchstart.zoom",null).on("touchmove.zoom",null).on("touchend.zoom",null)},vq.ScatterPlot.prototype.enableZoom=function(){var a=this;this.removeListeners(),this.data_g.select("g.plot_brush").remove(),this.data_g.select("svg.symbols").selectAll("circle").attr("class","fg"),this.data_rect.call(d3.behavior.zoom().x(this.xScale).y(this.yScale).on("zoom",function(){_.bind(a._render,a)()}))},vq.ScatterPlot.prototype.enableBrush=function(){this.removeListeners(),this.brush.x(this.xScale).y(this.yScale).on("brush",_.bind(this.brushHandler,this)).on("brushend",_.bind(this.brushEnd,this)),this.data_g.append("g").attr("class","plot_brush").call(this.brush)},vq.ScatterPlot.prototype.brushHandler=function(){var a=this,b=this.brush.extent();this.data_g.select("svg.symbols").selectAll("circle").attr("class",function(c){return b[0][0]<=c[a.x]&&c[a.x]<=b[1][0]&&b[0][1]<=c[a.y]&&c[a.y]<=b[1][1]?"fg":"bg"})},vq.ScatterPlot.prototype.brushEnd=function(){this.brush.empty()&&this.data_g.select("svg.dots").selectAll("circle").attr("class","fg")},vq.models.ScatterPlotData=function(a){vq.models.VisData.call(this,a),this.setDataModel(),this.getDataType()=="vq.models.ScatterPlotData"?this._build_data(this.getContents()):console.warn("Unrecognized JSON object.  Expected vq.models.ScatterPlotData object.")},vq.models.ScatterPlotData.prototype=vq.extend(vq.models.VisData),vq.models.ScatterPlotData.prototype.setDataModel=function(){this._dataModel=[{label:"width",id:"PLOT.width",cast:Number,defaultValue:400},{label:"height",id:"PLOT.height",cast:Number,defaultValue:300},{label:"container",id:"PLOT.container",optional:!0},{label:"vertical_padding",id:"PLOT.vertical_padding",cast:Number,defaultValue:20},{label:"horizontal_padding",id:"PLOT.horizontal_padding",cast:Number,defaultValue:30},{label:"data",id:"data_array",defaultValue:[]},{label:"COLUMNID.x",id:"xcolumnid",cast:String,defaultValue:"X"},{label:"COLUMNID.y",id:"ycolumnid",cast:String,defaultValue:"Y"},{label:"COLUMNID.value",id:"valuecolumnid",cast:String,defaultValue:"VALUE"},{label:"COLUMNLABEL.x",id:"xcolumnlabel",cast:String,defaultValue:""},{label:"COLUMNLABEL.y",id:"ycolumnlabel",cast:String,defaultValue:""},{label:"COLUMNLABEL.value",id:"valuecolumnlabel",cast:String,defaultValue:""},{label:"COLUMNLABEL.value",id:"valuecolumnlabel",cast:String,defaultValue:""},{label:"tooltipItems",id:"tooltip_items",defaultValue:{X:"X",Y:"Y",Value:"VALUE"}},{label:"_fillStyle",id:"fill_style",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return pv.color("steelblue").alpha(.2)}},{label:"_strokeStyle",id:"stroke_style",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"steelblue"}},{label:"_radius",id:"radius",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return 2}},{label:"_shape",id:"shape",cast:vq.utils.VisUtils.wrapProperty,defaultValue:function(){return"dot"}},{label:"_regression",id:"regression",cast:String,defaultValue:"none"},{label:"_notifier",id:"notifier",cast:Function,defaultValue:function(){return null}}]},vq.models.ScatterPlotData.prototype._build_data=function(a){this._processData(a),this.COLUMNLABEL.x==""&&(this.COLUMNLABEL.x=this.COLUMNID.x),this.COLUMNLABEL.y==""&&(this.COLUMNLABEL.y=this.COLUMNID.y),this.COLUMNLABEL.value==""&&(this.COLUMNLABEL.value=this.COLUMNID.value),this.data.length>0&&this.setDataReady(!0)}